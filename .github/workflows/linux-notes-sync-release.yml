name: Linux Notes Sync Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version (for manual runs, without leading v)
        required: false
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve version
        id: version
        shell: bash
        run: |
          if [[ "${GITHUB_REF:-}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="0.0.0-dev.${GITHUB_RUN_NUMBER}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Resolved version: $VERSION"

      - name: Install system dependencies
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            python3-pip \
            python3-tk \
            dpkg-dev \
            desktop-file-utils \
            patchelf \
            squashfs-tools \
            file \
            curl \
            xvfb

      - name: Install python build dependencies
        shell: bash
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pyinstaller

      - name: Validate project
        shell: bash
        run: |
          python3 -m py_compile notes_sync_linux/core.py notes_sync_linux/gui.py notes_sync_linux/main.py
          PYTHONPATH=. python3 -m unittest discover -s tests -v
          PYTHONPATH=. xvfb-run -a python3 scripts/gui_smoke_test.py

      - name: Prepare release notes
        shell: bash
        run: |
          ./scripts/extract_release_notes.sh "${{ steps.version.outputs.version }}" CHANGELOG.md dist/RELEASE_NOTES.md

      - name: Build release artifacts
        shell: bash
        run: |
          ./scripts/build_release_artifacts.sh "${{ steps.version.outputs.version }}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release-${{ steps.version.outputs.version }}
          path: |
            dist/*.deb
            dist/*.AppImage
            dist/SHA256SUMS.txt
          if-no-files-found: error

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          body_path: dist/RELEASE_NOTES.md
          files: |
            dist/*.deb
            dist/*.AppImage
            dist/SHA256SUMS.txt
