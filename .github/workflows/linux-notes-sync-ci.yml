name: Linux Notes Sync CI

on:
  push:
    paths:
      - "**"
  pull_request:
    paths:
      - "**"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install GUI dependencies
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            python3-tk \
            xvfb \
            libegl1 \
            libgl1 \
            libxkbcommon-x11-0 \
            libxcb-cursor0

      - name: Install Python UI dependencies
        shell: bash
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pyside6

      - name: Compile python files
        run: |
          python3 -m py_compile notes_sync_linux/core.py
          python3 -m py_compile notes_sync_linux/gui.py
          python3 -m py_compile notes_sync_linux/qt_gui.py
          python3 -m py_compile notes_sync_linux/main.py
          python3 -m py_compile notes_sync_linux/main_qt.py

      - name: Run unit tests
        env:
          PYTHONPATH: .
        run: |
          python3 -m unittest discover -s tests -v

      - name: GUI smoke test (xvfb)
        env:
          PYTHONPATH: .
        run: |
          xvfb-run -a python3 scripts/gui_smoke_test.py
          xvfb-run -a python3 scripts/gui_smoke_test_qt.py
